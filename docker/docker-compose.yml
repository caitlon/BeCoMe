# BeCoMe API - Docker Compose Configuration
#
# Usage (development):
#   docker compose up --build
#
# Usage (production-like with custom secret):
#   SECRET_KEY=$(openssl rand -hex 32) docker compose up --build
#
# Environment variables:
#   SECRET_KEY       - REQUIRED for production. Generate with: openssl rand -hex 32
#   POSTGRES_PASSWORD - Database password (default: become, CHANGE for production)
#   UVICORN_WORKERS  - Number of API workers (default: 4)
#   DEBUG            - Enable debug mode (default: false)
#   CORS_ORIGINS     - JSON array of allowed origins, e.g. '["http://localhost:3000"]'
#
# Production considerations:
#   - Always set SECRET_KEY via environment variable
#   - Change default database credentials
#   - Use managed PostgreSQL instead of bundled db service
#   - Remove or restrict exposed ports (5432)
#   - Run behind a reverse proxy (Nginx, Traefik)

services:
  # ============================================
  # PostgreSQL Database
  # ============================================
  db:
    image: postgres:16-alpine
    container_name: become-db
    restart: unless-stopped
    # WARNING: Default credentials for LOCAL DEVELOPMENT ONLY
    # For production: use environment variables or secrets management
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-become}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-become}
      POSTGRES_DB: ${POSTGRES_DB:-become}
    # WARNING: Port exposed for local development/debugging only
    # For production: remove this mapping or bind to 127.0.0.1:5432
    ports:
      - "127.0.0.1:5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-become} -d ${POSTGRES_DB:-become}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # ============================================
  # Redis (Token Blacklist)
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: become-redis
    restart: unless-stopped
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    command: redis-server --appendonly yes

  # ============================================
  # BeCoMe API (Production)
  # ============================================
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: become-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-become}:${POSTGRES_PASSWORD:-become}@db:5432/${POSTGRES_DB:-become}
      # SECRET_KEY is REQUIRED - generate with: openssl rand -hex 32
      SECRET_KEY: "${SECRET_KEY:?Set SECRET_KEY env var}"
      DEBUG: ${DEBUG:-false}
      # CORS_ORIGINS must be a valid JSON array string
      CORS_ORIGINS: '["http://localhost:3000"]'
      UVICORN_WORKERS: ${UVICORN_WORKERS:-4}
      # Redis for token blacklist
      REDIS_URL: redis://redis:6379/0
    depends_on:
      db:
        condition: service_healthy
        restart: true
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/v1/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ============================================
  # BeCoMe Frontend
  # ============================================
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: become-frontend
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      api:
        condition: service_healthy

  # ============================================
  # BeCoMe API (Development) - uncomment to use
  # ============================================
  # api-dev:
  #   build:
  #     context: ..
  #     dockerfile: docker/Dockerfile.dev
  #   container_name: become-api-dev
  #   ports:
  #     - "8000:8000"
  #   environment:
  #     DATABASE_URL: postgresql://${POSTGRES_USER:-become}:${POSTGRES_PASSWORD:-become}@db:5432/${POSTGRES_DB:-become}
  #     SECRET_KEY: "${SECRET_KEY:?SECRET_KEY is required}"
  #     DEBUG: "true"
  #     CORS_ORIGINS: '["http://localhost:3000"]'
  #   # Volume mounts without :ro to allow file generation (migrations, etc.)
  #   volumes:
  #     - ../src:/app/src
  #     - ../api:/app/api
  #   depends_on:
  #     db:
  #       condition: service_healthy

volumes:
  postgres_data:
    name: become-postgres-data
  redis_data:
    name: become-redis-data
