# BeCoMe - Docker Compose for Azure App Service + Supabase
#
# Usage:
#   cd docker
#   docker compose -f docker-compose.azure.yml --env-file ../.env up --build
#
# Required .env variables:
#   SECRET_KEY              - JWT secret (openssl rand -hex 32)
#   DATABASE_URL            - Supabase PostgreSQL connection string
#   SUPABASE_URL            - Supabase project URL
#   SUPABASE_KEY            - Supabase anon key
#   SUPABASE_STORAGE_BUCKET - Storage bucket name (default: become-photos)

services:
  # ============================================
  # BeCoMe API (Azure App Service + Supabase)
  # ============================================
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: become-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: ${DATABASE_URL}
      SECRET_KEY: ${SECRET_KEY}
      DEBUG: ${DEBUG:-false}
      CORS_ORIGINS: '["http://localhost:3000"]'
      UVICORN_WORKERS: ${UVICORN_WORKERS:-4}
      # Supabase Storage
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_KEY: ${SUPABASE_KEY}
      SUPABASE_STORAGE_BUCKET: ${SUPABASE_STORAGE_BUCKET:-become-photos}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/v1/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ============================================
  # BeCoMe Frontend
  # ============================================
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: become-frontend
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      api:
        condition: service_healthy
